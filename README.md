# 工程简介
IP隧道服务，用于公司内部爬虫服务的请求代理IP的管理，分发和分配，优质ip筛选，并发数限制。



# 需求分析
现在购买的第三方代理服务，会通过第三方接口返回对应的代理的ip和port，进而实现爬虫服务使用不同的代理IP去爬取数据。
但是随着够买的第三方代理越来越多，有点难以管理，所以需要构建一个IP隧道服务，进而实现代理ip的统一管理，和动态分配。



# 核心思路分析
该隧道服务需要把公司内部的服务请求（connect请求），通过这个隧道服务转发出去，把请求的header line，header，body按照原封不动的形式，传输给第三方代理的ip，port，代理服务商就会帮我们去直接获取目标地址的资源，然后返回给我的隧道服务，最后再响应数据给公司的内部服务
> 注意:
遇到的所有请求肯定都是connect代理请求，这些connect请求本身肯定有proxy认证信息，有访问的目标域名，端口，header信息。
不能直接转发这个请求给第三方代理商，需要重新构造一个代理请求发送给代理商。因为认证信息不一样。



# 需求补充（以服务健壮性为重心）



## 负载均衡

1.首先需要部署多个服务实例，每个实例就是一条隧道，将隧道服务做成分布式的，当大量的请求过来后，我们可以借用nginx的负载均衡（或者LVS做TCP层面的负载均衡），将这些请求均匀地路由分配到不同的服务实例上。



## 单进程多隧道
在proxy-server前面加一层springboot(ps：自带web容器)进行管理, 包括创建以下管理信息：
- 需要创建多少个proxy-server实例（对应就是多少条隧道）

- 每个实例的名称，ip，端口，部署的机器位置，需要cpu的核数，内存的总量，网络带宽的总量

- 每个实例需要创建多少boss线程数，worker线程数，连接时的用户名密码，缓存的代理ip总数，每个ip的有效时间，定时任务更新IP池的cron表达式

  

## 隧道初始化
1.初始化建立隧道的时候，需要根据mysql的配置信息进行创建，但是创建出来的所有隧道服务实例消耗的总带宽，不能超过机器带宽的80%，剩下的做备用。
2.根据mysql隧道实例配置列表，创建一个proxy server，监听一个独立的端口
3.隧道动态分配: 后续考虑使用 xxl-job做任务调度，实现根据下发的创建任务进行一个新的隧道的创建

> 注意：1.隧道实例的个数不能随意增加，减少，因为运维分配的端口只有10个(21330-21339)  2.目前也暂不支持隧道的动态创建（根据下发的创建任务进行new一个新的隧道）



## 业务线程安全机制

1.原则上，每条隧道会有一个初始化的线程池，所有的业务请求都会放入队列中，考虑到请求的时效性，每个线程一般处理3个代理请求任务，一定不能让队列有任务积压。那么1000个并发请求，需要设置核心线程数约为350，最大线程数500。业务线程在处理每一个代理请求的时候，需要对慢请求做超时处理（规定3秒钟为超时），放入到一个超时任务队列中（具有优先级的那种），并用单独的线程进行重试，重试3次无果，即返回超时等待的结果。

**超时时间：**

**超时参数配置**。需要根据每个服务的需求，做动态配置，因为有一些视频传输的特殊场景。

**慢请求线程处理。**比方说有500个线程，其中有10%数量的线程，都在处理慢请求。如果这些慢请求的线程超过10%的比例，需要主动中断处理慢请求的线程。防止后续的请求任务积压在队列中，影响其他请求。

**超时时间的设置。**后端重试次数乘以后端的超时时间，不能超过前端总的超时时间。



## ip池更新机制
- [ ] 一般来说，默认会5 min 拉取一次IP，注入到ip池中, ip池的数量会根据mysql配置参数来决定，默认10个（动态配置）。
- [x] 当ip池的数量过低，低于了30%，需要提前触发ip的拉取，不受时间间隔限制。
- [x] 当ip池的数量过高（每个隧道对应ip池的ip个数不能超过10个），需要取消ip的拉取。

**补充：**

**为了服务稳定，ip池的数量，必须全满，不能是动态变化的。**

**ip池的数量x(24hx60min/ip存活时间（分钟）)，小于代理商的每天的IP数量限制。 所以 IP总消耗量不能超过代理商每天分配的数量**

```java
// ip_pool_num*((24h*60)/ip_ttl) < ip_total
// 现在暂时不用考虑这个问题，因为ZhiMaService的拉取速率不会超过每天的数量限制。
```



## ip自动检测
- [ ] ip利用率的检测：每个ip的使用率需要做统计，在从IP池提取ip去处理请求的时候，需要对ip的引用次数做记录，防止大量请求只打到某几个ip上，导致其他ip没有使用，或使用率很低。
- [ ] ip质量检测：每个IP都有一个失效时间，为了提高ip的利用率，我们需要设置一个ip监控线程，在ip失效的前5s检查出来，并进行剔除。某个ip在首次使用后，会超时或失败，需要重试，重试3次过后都不行，会记录失败次数，导致成功率很低。这时就需要通过ip打分机制，将这个ip的权重降低，同时使用率也需要减少。然后会生成一个ip质量有序列表，最后由ip池监控线程将列表末尾的20%剔除掉。（**ps: 需要根据实际执行的日志分析得出结果，再决定如何剔除，因为可能会出现一种极端情况，大量的ip都是低质量的ip，如果全部剔除就会影响服务**）
- [ ] ip打分机制：可以参考elasticsearch的权重打分机制。



## 流量控制
- [x] 需要对每个隧道的并发量做控制，都在1000左右。具体的请求数量限制，由服务器带宽，ip池数量，业务线程可用数量，综合决定，做一个动态的控制。(**ps: 每个隧道的并发量的控制，现在暂时设成固定的1000或者500**)
- [x] 所有的隧道消耗的带宽，加起来不能超过机器总带宽的80%。每条隧道初始化10MB（**ps：暂时不用考虑，因为部署的服务所在的机器，都是一些千兆网卡，公司内部服务的所有请求过来，基本上也不会超过其设定的值。**）



## 日志记录

日志需要清晰的记录转发过程：来源ip，来源请求类型，使用的哪个隧道服务，使用的哪个代理ip，请求的响应结果如何，请求耗时多长，请求超时或错误的具体原因信息。



# 服务部署

```shell
机器地址：61-> adx-crawl-007   172.18.211.168  120.25.162.186   16/32G
部署路径：/usr/local/htdocs/tunnel-proxy
日志路径：/data0/logs/tunnel-proxy
启动参数：-Dspring.profiles.active=product -Dserver.port=21330
端口使用：21330~21339   #这10个端口是规划给 tunnel-proxy 这个服务的
```



# 其他

win10 杀死端口占用的进程
查看所有进程：netstat -nao
查找指定端口进程： netstat -nao|find "8080" （这里的8080指要查找的端口号）
终止指定PID进程：taskkill /pid 8548 -F（这里的8548指要终止进程对应的PID号）



## 注意

1.根据MySQL初始化不同的隧道列表，每条隧道对应都有一个代理ip环形队列作为ip池（注意：芝麻代理的每个ip获取都是根据你的本机器的ip来计算的，
不同的机器ip请求获取的时候，代理IP的可用个数会对应减1，相同的ip获取的时候，只会当作一个）



# AB测试

ab -n 1000 -c 1 http://13.209.21.196:8080/trade-server/test/order/testQueue



# 问题记录

### 线上大量请求后，代理 ip 报出connect time out

- 第一步，使用代理ip和非代理ip的方式，在本地压测百度，新浪，查看区别
  本地直接请求百度：1000个线程，超过1000个会报socket closed，read timed out，EOFException异常

  代理ip请求百度：1000个线程就会报, connection timed out()

- 第二部，如果对比后发现代理IP有问题，就调整线程数，查看最大值是多少
- 第三步，使用代理ip下，每5秒，打印每个ip的使用次数，成功次数，失败次数，带宽大小



Apn-Proxy纯netty支持和Tunnel-Proxy业务线程池的增强，在相同并发下，进行压力测试



# 常见错误

Unexpected response code for CONNECT: 401

表示没有权限，或者ip时间已经过期



# 命令

统计错误请求有多少个，以及每个错误占用有多少

```shell
cat adx-ReqMonitorUtils.log | grep 'false, pangolin' | awk -F ', ' '{print($2,$6)}' |awk -F '!' '{count[$1]++} END {for(i in count ){print(i,count[i])}}'
```



# 稳定性修复

- 错误

```
ForwardRequestTask forward_handler 连接代理IP [221.10.104.151:4231(2022-04-19 20:20:52)] 失败 100
DirectRelayHandler exceptionCaught Connection reset by peer 107
```



- 解决步骤

1.使用隔离的独享ip测试出，单个ip的并发和带宽上限。

2.根据这个上限，以及调用方的请求数量，请求包量的大小，调整IP池的数量大小，使得请求的成功率在95%以上

- 拉取服务的ip池的直连ip测试

```
----------------------- 并发数：20 ------------------------
ip 106.110.200.73:4231(2022-04-20 16:29:16) 有效期小于1分钟，重新拉取
IP=180.120.181.241:4231(2022-04-20 16:30:55), 并发=20, 成功=0, 失败=200, 失败率=100%, 平均响应报文大小=0 kb
IP=58.52.86.168:4231(2022-04-20 16:35:16), 并发=20, 成功=193, 失败=7, 失败率=3.5%, 平均响应报文大小=333 kb
IP=180.120.181.241:4231(2022-04-20 16:30:55), 并发=20, 成功=0, 失败=200, 失败率=100%, 平均响应报文大小=0 kb
IP=58.52.86.168:4231(2022-04-20 16:35:16), 并发=20, 成功=196, 失败=4, 失败率=2%, 平均响应报文大小=338 kb
并发数：20, 耗时：139s
----------------------- 并发数：30 ------------------------
IP=58.52.86.168:4231(2022-04-20 16:35:16), 并发=30, 成功=272, 失败=28, 失败率=9.33%, 平均响应报文大小=313 kb
IP=110.86.176.75:4231(2022-04-20 16:34:01), 并发=30, 成功=282, 失败=18, 失败率=6%, 平均响应报文大小=324 kb
IP=58.52.86.168:4231(2022-04-20 16:35:16), 并发=30, 成功=287, 失败=13, 失败率=4.33%, 平均响应报文大小=330 kb
IP=42.177.140.61:4231(2022-04-20 16:35:46), 并发=30, 成功=299, 失败=1, 失败率=0.33%, 平均响应报文大小=344 kb
IP=114.239.1.92:4245(2022-04-20 16:47:07), 并发=30, 成功=297, 失败=3, 失败率=1%, 平均响应报文大小=342 kb
并发数：30, 耗时：405s
----------------------- 并发数：40 ------------------------
ip 120.42.133.192:4246(2022-04-20 16:37:40) 有效期小于1分钟，重新拉取
ip 42.4.119.104:4231(2022-04-20 16:44:31) 有效期小于1分钟，重新拉取
IP=112.192.147.154:4263(2022-04-20 16:39:00), 并发=40, 成功=292, 失败=108, 失败率=27%, 平均响应报文大小=252 kb
IP=114.239.1.92:4245(2022-04-20 16:47:07), 并发=40, 成功=392, 失败=8, 失败率=2%, 平均响应报文大小=338 kb
IP=125.111.148.19:4245(2022-04-20 16:48:31), 并发=40, 成功=295, 失败=105, 失败率=26.25%, 平均响应报文大小=254 kb
并发数：40, 耗时：370s
----------------------- 并发数：50 ------------------------
ip 42.84.165.11:4243(2022-04-20 16:49:58) 有效期小于1分钟，重新拉取 
ip 42.84.165.11:4243(2022-04-20 16:49:58) 有效期小于1分钟，重新拉取
ip 182.204.157.141:4231(2022-04-20 16:49:58) 有效期小于1分钟，重新拉取
IP=114.239.1.92:4245(2022-04-20 16:47:07), 并发=50, 成功=444, 失败=56, 失败率=11.2%, 平均响应报文大小=306 kb
IP=125.111.148.19:4245(2022-04-20 16:48:31), 并发=50, 成功=315, 失败=185, 失败率=37%, 平均响应报文大小=217 kb
并发数：50, 耗时：363s
```



- 直连ip测试

```
----------------------- 并发数：20 ------------------------
IP=110.87.251.2:4245(2022-04-20 16:13:38), 并发=20, 成功=199, 失败=1, 失败率=0.5%, 平均响应报文大小=344
IP=110.87.251.2:4245(2022-04-20 16:13:38), 并发=20, 成功=196, 失败=4, 失败率=2%, 平均响应报文大小=338
IP=110.87.251.2:4245(2022-04-20 16:13:38), 并发=20, 成功=199, 失败=1, 失败率=0.5%, 平均响应报文大小=343
IP=110.87.251.2:4245(2022-04-20 16:13:38), 并发=20, 成功=200, 失败=0, 失败率=0%, 平均响应报文大小=345
IP=110.87.251.2:4245(2022-04-20 16:13:38), 并发=20, 成功=198, 失败=2, 失败率=1%, 平均响应报文大小=342
并发数：20, 耗时：680s
----------------------- 并发数：30 ------------------------
IP=125.87.81.83:4278(2022-04-20 16:24:58), 并发=30, 成功=297, 失败=3, 失败率=1%, 平均响应报文大小=342
IP=125.87.81.83:4278(2022-04-20 16:24:58), 并发=30, 成功=298, 失败=2, 失败率=0.67%, 平均响应报文大小=343
IP=125.87.81.83:4278(2022-04-20 16:24:58), 并发=30, 成功=297, 失败=3, 失败率=1%, 平均响应报文大小=342
IP=125.87.81.83:4278(2022-04-20 16:24:58), 并发=30, 成功=298, 失败=2, 失败率=0.67%, 平均响应报文大小=343
IP=125.87.81.83:4278(2022-04-20 16:24:58), 并发=30, 成功=299, 失败=1, 失败率=0.33%, 平均响应报文大小=344
并发数：30, 耗时：75s
----------------------- 并发数：40 ------------------------
IP=113.218.239.28:4231(2022-04-20 16:26:14), 并发=40, 成功=349, 失败=51, 失败率=12.75%, 平均响应报文大小=301
IP=113.218.239.28:4231(2022-04-20 16:26:14), 并发=40, 成功=324, 失败=76, 失败率=19%, 平均响应报文大小=279
IP=113.218.239.28:4231(2022-04-20 16:26:14), 并发=40, 成功=356, 失败=44, 失败率=11%, 平均响应报文大小=307
IP=113.218.239.28:4231(2022-04-20 16:26:14), 并发=40, 成功=321, 失败=79, 失败率=19.75%, 平均响应报文大小=277
IP=113.218.239.28:4231(2022-04-20 16:26:14), 并发=40, 成功=294, 失败=106, 失败率=26.5%, 平均响应报文大小=254
并发数：40, 耗时：490s
```



- 独享ip测试

```
----------------------- 并发数：20 ------------------------
IP=58.46.250.231:4213(2022-04-20 15:29:07), 并发=20, 成功=197, 失败=3, 失败率=1.5%, 平均响应报文大小=340
IP=58.46.250.231:4213(2022-04-20 15:29:07), 并发=20, 成功=200, 失败=0, 失败率=0%, 平均响应报文大小=345
IP=58.46.250.231:4213(2022-04-20 15:29:07), 并发=20, 成功=197, 失败=3, 失败率=1.5%, 平均响应报文大小=340
IP=58.46.250.231:4213(2022-04-20 15:29:07), 并发=20, 成功=195, 失败=5, 失败率=2.5%, 平均响应报文大小=336
IP=58.46.250.231:4213(2022-04-20 15:29:07), 并发=20, 成功=196, 失败=4, 失败率=2%, 平均响应报文大小=338
并发数：20, 耗时：236s
----------------------- 并发数：30 ------------------------
IP=171.110.83.65:4263(2022-04-20 15:23:46), 并发=30, 成功=298, 失败=2, 失败率=0.67%, 平均响应报文大小=343
IP=171.110.83.65:4263(2022-04-20 15:23:46), 并发=30, 成功=299, 失败=1, 失败率=0.33%, 平均响应报文大小=344
IP=171.110.83.65:4263(2022-04-20 15:23:46), 并发=30, 成功=299, 失败=1, 失败率=0.33%, 平均响应报文大小=344
IP=171.110.83.65:4263(2022-04-20 15:23:46), 并发=30, 成功=298, 失败=2, 失败率=0.67%, 平均响应报文大小=343
IP=171.110.83.65:4263(2022-04-20 15:23:46), 并发=30, 成功=192, 失败=108, 失败率=36%, 平均响应报文大小=221
并发数：30, 耗时：302s
----------------------- 并发数：40 ------------------------
IP=153.36.73.144:4278(2022-04-20 15:41:31), 并发=40, 成功=322, 失败=78, 失败率=19.5%, 平均响应报文大小=278
IP=153.36.73.144:4278(2022-04-20 15:41:31), 并发=40, 成功=381, 失败=19, 失败率=4.75%, 平均响应报文大小=329
IP=153.36.73.144:4278(2022-04-20 15:41:31), 并发=40, 成功=383, 失败=17, 失败率=4.25%, 平均响应报文大小=330
IP=153.36.73.144:4278(2022-04-20 15:41:31), 并发=40, 成功=391, 失败=9, 失败率=2.25%, 平均响应报文大小=337
IP=153.36.73.144:4278(2022-04-20 15:41:31), 并发=40, 成功=391, 失败=9, 失败率=2.25%, 平均响应报文大小=337
并发数：40, 耗时：374s
----------------------- 并发数：50 ------------------------
IP=114.96.198.114:4245(2022-04-20 15:47:45), 并发=50, 成功=448, 失败=52, 失败率=10.4%, 平均响应报文大小=309
IP=114.96.198.114:4245(2022-04-20 15:47:45), 并发=50, 成功=491, 失败=9, 失败率=1.8%, 平均响应报文大小=339
IP=114.96.198.114:4245(2022-04-20 15:47:45), 并发=50, 成功=492, 失败=8, 失败率=1.6%, 平均响应报文大小=339
IP=114.96.198.114:4245(2022-04-20 15:47:45), 并发=50, 成功=449, 失败=51, 失败率=10.2%, 平均响应报文大小=310
IP=114.96.198.114:4245(2022-04-20 15:47:45), 并发=50, 成功=491, 失败=9, 失败率=1.8%, 平均响应报文大小=339
并发数：50, 耗时：912s
```

- 结论

```
测试访问 https://www.baicu.com，返回的数据大小345kb
单个ip的带宽在并发30左右得出的情况：(345kb*30)/1024 约等于10MB左右
所以隧道服务在规划ip的时候，应该遵循这个公式：单个ip的请求数量*每个请求的平均大小包量 <= 8MB（ps:不取10MB是因为，留下20%的缓冲空间，为了预防突发情况，比如网络抖动）。
如果现在需要满足1000的并发，每个请求的大小设定15000字节，每秒需要响应传输的数据大小是500000KB，如果按照单个ip可承载 8MB 算，应该满足以下公式：
    每秒1000个请求 * 每次传输的数据报文大小（15000/1024=14.6KB）< 8MB * 1024 * ip池的数量。
所以算出ip池的数量为：2（按照3个ip算，用一个ip做意外缓冲）
// 最终出一个模糊的概念：1000并发 20KB 3个ip

优量广告每小时的请求量：15W，按照20W算，计算出每秒中56个请求，按照100个来算。每个请求大小：1 kb，按2KB算。响应大小：21 kb，按40KB算 
```

3.后续再做做隧道的风控，频率控制



# 备忘录

统计上（请求）下（响应）行的数据大小。

ip池的每个ip提前检查，还有1分钟过期就判定为失效。



# 隧道测试

```
// 测试参数：https://www.baidu.com 每个线程2个任务
并发：200, 成功=343, 失败=57, 失败率=14.25, 错误原因列表：{SSL peer shut down incorrectly=4, Read timed out=3, timeout=50}
并发：300, 成功=473, 失败=127, 失败率=21.17, 错误原因列表：{SSL peer shut down incorrectly=10, Read timed out=5, timeout=101}

// 优量广告测试地址：https://mi.gdt.qq.com/gdt_mview.fcg?posid=5000155655915649& 每个线程2个任务
并发：200, 成功=400, 失败=0, 失败率=0, 错误原因列表：{}
并发：300, 成功=600, 失败=0, 失败率=0, 错误原因列表：{}
并发：400, 成功=800, 失败=0, 失败率=0, 错误原因列表：{}
并发：500, 成功=999, 失败=1, 失败率=0.1, 错误原因列表：{Read timed out=1}
并发：600, 成功=1197, 失败=3, 失败率=0.25, 错误原因列表：{Read timed out=2, timeout=1}
并发：700, 成功=789, 失败=611, 失败率=43.64, 错误原因列表：{Read timed out=393, timeout=204}
```

