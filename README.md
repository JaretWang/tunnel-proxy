# 工程简介
IP隧道服务，用于公司内部爬虫服务的请求代理IP的管理，分发和分配。

# 需求分析
现在购买的第三方代理服务，会通过第三方接口返回对应的代理的ip和port，进而实现爬虫服务使用不同的代理IP去爬取数据。
但是随着够买的第三方代理越来越多，有点难以管理，所以需要构建一个IP隧道服务，进而实现代理ip的统一管理，和动态分配。


# 核心思路分析
该隧道服务需要把公司内部的服务请求（connect请求），通过这个隧道服务转发出去，把请求的header line，header，body按照原封不动的形式，传输给第三方代理的ip，port，代理服务商就会帮我们去直接获取目标地址的资源，
然后返回给我的隧道服务，最后再响应数据给公司的内部服务
## 补充
遇到的所有请求肯定都是connect代理请求，这些connect请求本身肯定有proxy认证信息，有访问的目标域名，端口，header信息。
不能直接转发这个请求给第三方代理商，需要重新构造一个代理请求发送给代理商。因为认证信息不一样。

# 后续需求升级
## 服务实例的负载均衡
1.首先需要部署多个服务实例（如：3个），将隧道服务做成分布式的，当大量的请求过来后，我们可以借用nginx的负载均衡，将这些请求均匀地路由分配到不同的服务实例上。
2.也可以参考hashmap的数据结构，使用hash算法，对长度取余，算出本来的请求应该打到哪一个服务实例上。

## 隧道分配
初始化建立3条隧道，供所有服务使用，将总带宽的60%均匀地分配在这3条隧道上。
当有新的服务想要接入隧道服务：
1.随机分配一条隧道使用，但是可能会影响其他服务的使用。
2.如果不想影响其他服务，需要使用剩下的40%的带宽，重新建立一条新的隧道。
3.最后别无选择的话，就增加服务器网络带宽总量。

## ip数量分配
1.初始化隧道的时候，有多少隧道就创建多少个队列(可以借助服务之外的内存，redis)，并初始化好一批代理ip，放入redis，并随机设置有效期5-25分钟（注意：别设置成一样，防止一大批代理ip过期，没有可用的ip了）
2.代理ip池，需要每5分钟更新一批（每一批初步暂定50个）

## 业务线程安全机制
1.每个业务线程对应一个代理请求，需要对慢请求做超时处理（规定3秒钟为超时），放入到一个超时任务队列中（具有优先级的那种），并用单独的线程进行重试，重试3次无果，即返回超时等待的结果。
2.初始化业务线程数量: 200-400。当遇到高峰期的时段，如果发现70%的线程都在运行中，就需要做线程池的数量扩容。

## 流量控制
1.需要对每个内网服务的请求数量做限流。具体的请求数量限制，由服务器带宽，ip池数量，业务线程可用数量，综合决定，做一个动态的控制。

